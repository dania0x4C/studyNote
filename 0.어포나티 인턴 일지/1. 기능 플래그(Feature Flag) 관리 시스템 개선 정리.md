

## ê¸°ëŠ¥ í”Œë˜ê·¸ë€?
ê¸°ëŠ¥ í”Œë˜ê·¸ëŠ” íŠ¹ì • ê¸°ëŠ¥ì„ ë™ì ìœ¼ë¡œ í™œì„±í™”í•˜ê±°ë‚˜ ë¹„í™œì„±í™”í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ì¡°ê±´ë¶€ ì½”ë“œ ì‹¤í–‰ ë©”ì»¤ë‹ˆì¦˜ì…ë‹ˆë‹¤. íŠ¹íˆ íŠ¹ì • ì‚¬ìš©ì ê·¸ë£¹ì´ë‚˜ íŠ¹ì • ì¡°ê±´ì— ë”°ë¼ ê¸°ëŠ¥ ì ‘ê·¼ì„ ì œí•œí•˜ê±°ë‚˜ ì œê³µí•  ìˆ˜ ìˆìœ¼ë©°, ë°ì´í„° ê´€ë¦¬ ë° ì„œë¹„ìŠ¤ ì•ˆì •ì„± ê´€ì ì—ì„œ ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤.

###  ì£¼ìš” í™œìš© ì‚¬ë¡€
- ìœ íŠœë¸Œì˜ PIP(Picture-in-Picture) ëª¨ë“œ ë“± íŠ¹ì • ê¸°ëŠ¥ í™œì„±í™”/ë¹„í™œì„±í™”
- ê¸°ê°„ë³„, ì‚¬ìš©ìë³„, ì´ë²¤íŠ¸ë³„ë¡œ ìœ ì—°í•˜ê²Œ ì„œë¹„ìŠ¤ ì¡°ê±´ ë³€ê²½

---

##  ì¥ì 
- ì›¹ì´ë‚˜ ì•±ì˜ ì„¤ì • ë³€ê²½ ì—†ì´ ë¹ ë¥´ê²Œ ê¸°ëŠ¥ì„ í™œì„±í™”/ë¹„í™œì„±í™” ê°€ëŠ¥
- ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶œì‹œ ì‹œ ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¹ ë¥´ê²Œ ë¡¤ë°± ê°€ëŠ¥
- ê¸°ëŠ¥ì˜ ì‹¤í—˜ì  ìš´ì˜ ë° ì ì§„ì  ë°°í¬ ê°€ëŠ¥

### ëŒ€í‘œì  ì˜¤í”ˆì†ŒìŠ¤
- flagd

---

##  ê¸°ëŠ¥ í”Œë˜ê·¸ í™œìš© ì˜ˆì‹œ
| ì˜ˆì‹œ | í”Œë˜ê·¸ ì´ë¦„ |
|------|------------|
| íŠ¹ì • ê¸°ê°„ ë‚´ ê°€ê²© ì¡°ì • | `TEMPORARY_UNIT_PRICE_OVERRIDE` |
| íŠ¹ì • íšŸìˆ˜ ì œí•œ ê°€ê²© ì¡°ì • | `LIMITED_USAGE_UNIT_PRICING` |
| ì´ìš©ê¶Œ í• ì¸ | `TIME_BASED_VOUCHER_DISCOUNT` |
| ì‹ ê·œ ê°€ì… í”„ë¡œëª¨ì…˜ | `NEW_MEMBER_PROMOTION` |
| ë¬´ë£Œ ì²´í—˜ í‹°ì¼“ ì œê³µ | `FREE_TRIAL_TICKETS` |
| í° ì´ë¯¸ì§€ ì¶”ê°€ í‹°ì¼“ | `LARGE_IMAGE_EXTRA_TICKET_COST` |
| ì‹œê°„ëŒ€ë³„ í• ì¸ | `TIME_BASED_DISCOUNT` |

---

##  ë°ì´í„° êµ¬ì¡° (TypeORM í™œìš©)

- ìƒì„± ì‹œê°„, ì—…ë°ì´íŠ¸ ì‹œê°„, ì‚­ì œ ì‹œê°„, ì •ì±… ì‹œì‘/ì¢…ë£Œ ì‹œê°„ ê´€ë¦¬
- ìš°ì„ ìˆœìœ„ ì„¤ì • ë° ì ìš© ëŒ€ìƒ ì •ë³´ ê´€ë¦¬ (íšŒì› ê°€ì… ê¸°ê°„, êµ¬ë§¤ì¼, ëª¨ë“  ì‚¬ìš©ì ë“±)
- ìƒíƒœ ê´€ë¦¬(enum í™œìš©, Active / Inactive)

---

## ê°œë°œ ì¤‘ ì£¼ìš” ë¬¸ì œì  ë° í•´ê²° ë°©í–¥

### 1. ì •ì±… ê´€ë¦¬ ê¸°ëŠ¥ì˜ ê³¼ë„í•œ ë³µì¡ì„±
- ê¸°ì¡´ì˜ ì •ì±… ìƒì„±, ìˆ˜ì •, ì‚­ì œ, ì˜¨ì˜¤í”„ ê¸°ëŠ¥ êµ¬í˜„ì´ ì½”ë“œ ë³µì¡ì„±ì„ ë†’ì´ê³  ìœ ì§€ë³´ìˆ˜ë¥¼ ì–´ë µê²Œ ë§Œë“¦.
- **í•´ê²° ë°©í–¥:** ìµœì†Œí•œì˜ ê´€ë¦¬ë§Œ ì§€ì›í•˜ê³  ì •ì±…ì„ ì§ì ‘ ìˆ˜ì •í•˜ì§€ ì•Šê³  ìƒì„±ìœ¼ë¡œ ì²˜ë¦¬í•˜ë©°, í™œì„±í™” ìƒíƒœë§Œ ì§ê´€ì ìœ¼ë¡œ ê´€ë¦¬.

### 2. ì •ì±… ì ìš© ë¡œì§ì˜ ëª…í™•ì„± ë¶€ì¡±
- ê¸°ì¡´ ë¡œì§ì´ ë‹¨ìˆœíˆ ê°’ì„ ë°˜í™˜í•˜ëŠ” ë° ì´ˆì ì„ ë‘ê³  ìˆì–´ ì •ì±…ì˜ ì ìš© ìš°ì„ ìˆœìœ„ë‚˜ ì‹œê°„ ê¸°ë°˜ ì²˜ë¦¬ ëª…í™•ì„± ë¶€ì¡±.
- **í•´ê²° ë°©í–¥:** ìš°ì„ ìˆœìœ„ì™€ ì‹œê°„ ì¡°ê±´ì„ ëª…í™•í•˜ê²Œ ì •ì˜í•˜ê³ , ìµœì‹  ì •ì±…ì˜ ì ìš© ì—¬ë¶€ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ ê°€ì¥ ì í•©í•œ ê°’ì„ ìë™ ë°˜í™˜.

### 3. ìš°ì„ ìˆœìœ„ ë° ì‹œê°„ ì¡°ê±´ì˜ ë³µì¡ì„±
- ì—¬ëŸ¬ ì •ì±…ì´ ê²¹ì¹  ê²½ìš° ìš°ì„ ìˆœìœ„ì™€ ì ìš© ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ ë³µì¡í•œ íŒë‹¨ì´ í•„ìš”.
- **í•´ê²° ë°©í–¥:** ì ìš© ì •ì±… ì¤‘ ê°€ì¥ ìµœê·¼ ë° ë†’ì€ ìš°ì„ ìˆœìœ„ ì •ì±…ì„ ê¸°ì¤€ìœ¼ë¡œ ì„ íƒí•˜ì—¬ ì²˜ë¦¬í•˜ë„ë¡ ê°„ì†Œí™”.

### 4. ë³€ê²½ ê°€ëŠ¥í•œ ë°ì´í„°ì˜ ê´€ë¦¬
- ìˆ˜ì¹˜ì ì¸ ë³€í™”(í‹°ì¼“ ê°€ê²©, í‹°ì¼“ ìˆ˜ ë“±)ë¥¼ ê´€ë¦¬í•˜ëŠ” ë¡œì§ì´ ì¤‘ë³µë˜ê³  ìœ ì§€ë³´ìˆ˜ê°€ ì–´ë ¤ì›Œì§.
- **í•´ê²° ë°©í–¥:** ìˆ˜ì¹˜ ë³€í™˜ ë° ê³„ì‚°ì„ í•˜ë‚˜ì˜ ëª¨ë“ˆë¡œ í†µí•©í•˜ì—¬ ì¼ê´€ì„±ì„ ë†’ì´ê³  ì¬ì‚¬ìš©ì„±ì„ í™•ë³´.

---

## ğŸ› ï¸ ìµœì¢… ê°œì„  ì „ëµ

### 1. ì •ì±… ë°ì´í„° ê°„ì†Œí™”
- Active / Inactive ìƒíƒœë§Œ ê´€ë¦¬í•˜ì—¬ ì§ê´€ì ìœ¼ë¡œ ì„¤ì •.

### 2. ì‹œê°„ ë° ìš°ì„ ìˆœìœ„ ê¸°ë°˜ ì •ì±… ì ìš©
- ìµœì‹  ë° ê°€ì¥ ë†’ì€ ìš°ì„ ìˆœìœ„ë¥¼ ê°€ì§„ ì •ì±…ë§Œ í™œì„±í™”.
- ì •ì±…ì´ ì¤‘ë³µ ì ìš© ì‹œ ìµœê·¼ ì •ì±…ì„ ìš°ì„  ì ìš©í•˜ê³  ì´ì „ ì •ì±…ì€ ìë™ ë¹„í™œì„±í™” ì²˜ë¦¬.

### 3. ì˜ˆì•½ ì •ì±…ì˜ ëª…í™•í•œ ê´€ë¦¬
- ì˜ˆì•½ ì •ì±… ìµœëŒ€ 3ê°œ ì œí•œ.
- ìƒˆ ì •ì±… ìƒì„± ì‹œ ê¸°ì¡´ ì •ì±…ê³¼ ì‹œê°„ ê²¹ì¹¨ ì—¬ë¶€ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ê´€ë¦¬í•˜ì—¬ í˜¼ë€ ë°©ì§€.

### 4. ë°ì´í„° ì¡°íšŒ ë¡œì§ ê°œì„ 
- ë§ˆì§€ë§‰ ë‘ ê°œì˜ ì •ì±… ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í˜„ì¬ ì ìš© ê°€ëŠ¥í•œ ì •ì±…ê³¼ ì˜ˆì•½ ì •ì±… ëª…í™•íˆ êµ¬ë¶„í•˜ì—¬ ë°˜í™˜.

---

##  ìµœì¢… ì¡°íšŒ ë¡œì§ (Pseudo ì½”ë“œ ì˜ˆì‹œ)

```typescript
private async getLatestFlags(key: string) {
  // í‚¤ì— ëŒ€í•œ ìµœê·¼ ë‘ ê°œì˜ í”Œë˜ê·¸ ì¡°íšŒ
  const flags = await this.flagRepository.findLatestTwoFlagsByKey(key);
  await this.flagRepository.flagFindOneOrFail(key);

  const now = new Date();
  const [latestFlag, previousFlag = null] = flags;

  // í˜„ì¬ ì‹œê°„ì´ í”Œë˜ê·¸ì˜ ì ìš© ê¸°ê°„ ë‚´ì¸ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
  const isFlagActive = (flag: any) =>
    flag && this.isInDateRange(flag.startDate, flag.endDate, now);

  return {
    flags,
    now,
    latestFlag,
    previousFlag,
    isLatestCurrent: isFlagActive(latestFlag),
    isPreviousCurrent: isFlagActive(previousFlag),
  };
}

/**
 * í”Œë˜ê·¸ ìƒì„± ë¡œì§
 */
async createFlag({
  startDate: inputStartDate,
  endDate: inputEndDate,
  ...createFlagDto
}: CreateFlagReqDto): Promise<string> {
  // ì…ë ¥ëœ ë‚ ì§œì˜ ìœ íš¨ì„± ê²€ì¦
  const { startDate, endDate } = await validateDates(
    inputStartDate,
    inputEndDate,
  );

  // ê¸°ì¡´ í”Œë˜ê·¸ ì¡°íšŒ
  const existingFlags = await this.flagRepository.flagFindAllByKey(createFlagDto.key);
  const now = new Date();

  // ì˜ˆì•½ëœ í”Œë˜ê·¸ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
  const hasReservation = existingFlags.some(flag => new Date(flag.startDate) > now);

  if (hasReservation) {
    const [nextReserved] = existingFlags
      .filter(flag => new Date(flag.startDate) > now)
      .sort((a, b) => new Date(a.startDate).getTime() - new Date(b.startDate).getTime());

    throw new FlagReservationException(
      createFlagDto.key,
      `ì´ë¯¸ ì˜ˆì•½ëœ í”Œë˜ê·¸ê°€ ìˆìŠµë‹ˆë‹¤. ì˜ˆì•½ ì‹œì‘ì¼: ${new Date(nextReserved.startDate).toISOString()}`,
    );
  }

  // ìƒˆë¡œìš´ í”Œë˜ê·¸ ìƒì„± ë° ì €ì¥
  const newFlag = this.flagTypeormRepository.create({
    ...createFlagDto,
    startDate,
    endDate,
  });

  const { key } = await this.flagTypeormRepository.save(newFlag);
  return key;
}

/**
 * íŠ¹ì • í‚¤ì— ëŒ€í•œ í˜„ì¬ í™œì„±í™”ëœ í”Œë˜ê·¸ ê°’ ì¡°íšŒ (ì‚¬ìš©ììš©)
 */
async getFlagValue(key: string): Promise<FlagValueInfoDto> {
  const flag = await this.flagRepository.flagFindOneOrFail(key);

  return {
    key: flag.key,
    value: flag.value,
    type: flag.type,
    startDate: flag.startDate,
    endDate: flag.endDate,
  };
}

/**
 * íŠ¹ì • í‚¤ì— ëŒ€í•œ í˜„ì¬ ë° ì˜ˆì•½ í”Œë˜ê·¸ ì¡°íšŒ
 */
async getFlagValues(key: string): Promise<FlagValuesResponseDto> {
  const {
    now,
    latestFlag,
    previousFlag,
    isLatestCurrent,
    isPreviousCurrent,
  } = await this.getLatestFlags(key);

  const response: FlagValuesResponseDto = {
    key,
    current: null,
    reserve: null,
  };

  const isReserved = new Date(latestFlag.startDate) > now;

  if (isReserved) {
    // í˜„ì¬ í™œì„±í™”ëœ í”Œë˜ê·¸ê°€ ì´ì „ í”Œë˜ê·¸ë¼ë©´ ì„¤ì •
    if (previousFlag && isPreviousCurrent) {
      response.current = { ...previousFlag };
    }
    // ì˜ˆì•½ëœ í”Œë˜ê·¸ ì„¤ì •
    response.reserve = { ...latestFlag };
  } else if (isLatestCurrent) {
    // ìµœì‹  í”Œë˜ê·¸ê°€ í˜„ì¬ í™œì„±í™”ëœ ê²½ìš° ì„¤ì •
    response.current = { ...latestFlag };
  }

  return response;
}

```

---

## ğŸ”‘ ê²°ë¡ 

ê¸°ëŠ¥ í”Œë˜ê·¸ ê´€ë¦¬ ì‹œìŠ¤í…œì€ ë³µì¡í•œ ê¸°ëŠ¥ í™œì„±í™”/ë¹„í™œì„±í™” ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ë° ìœ ìš©í•˜ì§€ë§Œ, ë³µì¡í•œ ë¡œì§ê³¼ ë§ì€ ë°ì´í„°ë¡œ ì¸í•´ ì˜¤íˆë ¤ ê´€ë¦¬ê°€ ì–´ë ¤ì›Œì§ˆ ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ **ë°ì´í„° ê´€ë¦¬ ë° ì •ì±… ì ìš©ì˜ ëª…í™•ì„±**ì„ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•˜ê³ , ë³µì¡ì„±ì„ ì¤„ì—¬ **ìœ ì§€ë³´ìˆ˜ê°€ ì‰¬ìš´ ê°„ê²°í•œ êµ¬ì¡°**ë¡œ ì„¤ê³„í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤.

